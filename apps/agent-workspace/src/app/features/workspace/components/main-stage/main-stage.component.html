<main class="main-stage">
  @if (hasPayloadUrl) {
    <!-- IFRAME MODE -->
    @if (activeDisplayMode === 'iframe') {
      <div class="iframe-container" [class.loaded]="iframeLoaded" [class.blocked]="iframeBlocked">
        @if (!iframeLoaded && !iframeBlocked) {
          <div class="iframe-loading">
            <div class="loading-spinner"></div>
            <span>Loading application...</span>
            @if (checkingEmbeddability) {
              <span class="checking-hint">Checking site compatibility...</span>
            }
          </div>
        }

        <!-- Blocked by CSP / X-Frame-Options -->
        @if (iframeBlocked) {
          <div class="iframe-blocked">
            <div class="blocked-content">
              <div class="blocked-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                </svg>
              </div>
              <h2>External Site Cannot Be Embedded</h2>
              <p class="blocked-reason">{{ iframeBlockedReason }}</p>
              <p class="blocked-explanation">
                This website has security settings that prevent it from being displayed inside
                another application. This is a common security measure. You can open it in a
                separate window instead.
              </p>
              <div class="blocked-actions">
                <button class="btn-primary" (click)="switchToPopup()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                  Open in New Window
                </button>
              </div>
            </div>
          </div>
        }

        @if (safePayloadUrl) {
          <iframe
            #taskIframe
            class="task-iframe"
            [class.hidden]="iframeBlocked"
            [src]="safePayloadUrl"
            title="Task Content"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
            (load)="onIframeLoad()"
            (error)="onIframeError()"
          ></iframe>
        }
      </div>
    }

    <!-- POPUP MODE (Screen Pop) -->
    @if (activeDisplayMode === 'popup') {
      <div class="popup-mode">
        <div class="popup-content">
          <div class="popup-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </div>
          <h2>Task Open in Separate Window</h2>
          <p class="popup-url">{{ popupUrl }}</p>
          <p class="popup-hint">
            The task application is open in a separate browser window. Work on the task
            there, then return here to complete, transfer, or disposition the task.
          </p>
          <div class="popup-actions">
            <button class="btn-primary" (click)="openPopup()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              Re-open Window
            </button>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="empty-state">
      <div class="empty-state-content">
        <div class="empty-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
        </div>
        <h2>No Task Loaded</h2>
        <p>Waiting for the next task assignment...</p>
      </div>
    </div>
  }
</main>
