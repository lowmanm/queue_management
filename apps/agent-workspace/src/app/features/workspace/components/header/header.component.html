<header class="workspace-header">
  <div class="header-left">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-btn" (click)="toggleMobileNav()" aria-label="Open navigation menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <a routerLink="/" class="app-title-link">
      <h1 class="app-title">Nexus Queue</h1>
    </a>

    <!-- Desktop Navigation Links -->
    <nav class="main-nav desktop-nav">
      <a routerLink="/workspace" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-link">
        Workspace
      </a>
      @if (canAccessManager) {
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn" [class.active]="isManagerActive">
            Manager
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="nav-dropdown-content">
            <a routerLink="/manager/team" routerLinkActive="active" class="dropdown-link">Team Dashboard</a>
            <a routerLink="/manager/queues" routerLinkActive="active" class="dropdown-link">Queue Monitor</a>
          </div>
        </div>
      }
      @if (canAccessDesigner) {
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn" [class.active]="isDesignerActive">
            Design
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="nav-dropdown-content">
            <a routerLink="/admin/volume-loaders" routerLinkActive="active" class="dropdown-link">Data Sources</a>
            <a routerLink="/admin/pipelines" routerLinkActive="active" class="dropdown-link">Pipelines</a>
            <a routerLink="/admin/dispositions" routerLinkActive="active" class="dropdown-link">Dispositions</a>
            <a routerLink="/admin/work-states" routerLinkActive="active" class="dropdown-link">Work States</a>
          </div>
        </div>
      }
      @if (canAccessAdmin) {
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn" [class.active]="isAdminActive">
            Admin
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="nav-dropdown-content">
            <a routerLink="/admin/users" routerLinkActive="active" class="dropdown-link">User Management</a>
          </div>
        </div>
      }
    </nav>
  </div>

  <!-- Center Stats (hidden on mobile) -->
  <div class="header-center">
    @if (headerStats$ | async; as stats) {
      <div class="session-metrics">
        <div class="metric">
          <span class="metric-value">{{ stats.tasksCompleted }}</span>
          <span class="metric-label">Completed</span>
        </div>
        <div class="metric">
          <span class="metric-value">{{ stats.avgHandleTime }}</span>
          <span class="metric-label">Avg Handle</span>
        </div>
        <div class="metric">
          <span class="metric-value">{{ stats.loggedInTime }}</span>
          <span class="metric-label">Session</span>
        </div>
        <div class="metric">
          <span class="metric-value">{{ stats.tasksPerHour }}</span>
          <span class="metric-label">Tasks/Hr</span>
        </div>
      </div>
    }
  </div>

  <div class="header-right">
    <!-- Agent Work State Controls -->
    <app-agent-controls></app-agent-controls>

    @if (user$ | async; as user) {
      <div class="user-info">
        <span class="user-name">{{ user.displayName }}</span>

        <!-- Role Badge with Switcher -->
        <div class="role-wrapper">
          <button
            class="role-badge"
            [class.active]="showRoleSwitcher"
            (click)="toggleRoleSwitcher()"
            title="Switch Role (Quick)"
            [attr.aria-expanded]="showRoleSwitcher"
            aria-haspopup="true"
          >
            {{ currentRoleLabel }}
          </button>

          @if (showRoleSwitcher) {
            <div class="role-dropdown">
              @for (role of roles; track role) {
                <button
                  class="role-option"
                  [class.selected]="user.role === role"
                  (click)="switchRole(role)"
                >
                  {{ role }}
                </button>
              }
            </div>
          }
        </div>

        <!-- Switch User button (testing) -->
        <button
          class="switch-user-btn"
          [class.active]="showUserSwitcher"
          (click)="toggleUserSwitcher()"
          title="Switch User Persona"
        >
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <polyline points="16 11 18 13 22 9"></polyline>
          </svg>
        </button>

        <!-- Logout button -->
        <button class="logout-btn" (click)="logout()" title="Logout">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>
    }

    <button class="debug-btn" (click)="onToggleLogs()" title="View Debug Logs">
      Logs
    </button>
  </div>
</header>

<!-- Mobile Navigation Drawer -->
@if (showMobileNav) {
  <div class="mobile-nav-overlay" (click)="closeMobileNav()" (keydown.escape)="closeMobileNav()" tabindex="-1" role="presentation"></div>
  <nav class="mobile-nav" aria-label="Mobile navigation">
    <div class="mobile-nav-header">
      <h2>Navigation</h2>
      <button class="close-nav-btn" (click)="closeMobileNav()" aria-label="Close navigation">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="mobile-nav-content">
      <div class="mobile-nav-section">
        <a routerLink="/workspace" class="mobile-nav-link" (click)="closeMobileNav()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="9"></rect>
            <rect x="14" y="3" width="7" height="5"></rect>
            <rect x="14" y="12" width="7" height="9"></rect>
            <rect x="3" y="16" width="7" height="5"></rect>
          </svg>
          Workspace
        </a>
      </div>

      @if (canAccessManager) {
        <div class="mobile-nav-section">
          <div class="mobile-nav-section-title">Manager</div>
          <a routerLink="/manager/team" class="mobile-nav-link" (click)="closeMobileNav()">Team Dashboard</a>
          <a routerLink="/manager/queues" class="mobile-nav-link" (click)="closeMobileNav()">Queue Monitor</a>
        </div>
      }

      @if (canAccessDesigner) {
        <div class="mobile-nav-section">
          <div class="mobile-nav-section-title">Design</div>
          <a routerLink="/admin/volume-loaders" class="mobile-nav-link" (click)="closeMobileNav()">Data Sources</a>
          <a routerLink="/admin/pipelines" class="mobile-nav-link" (click)="closeMobileNav()">Pipelines</a>
          <a routerLink="/admin/dispositions" class="mobile-nav-link" (click)="closeMobileNav()">Dispositions</a>
          <a routerLink="/admin/work-states" class="mobile-nav-link" (click)="closeMobileNav()">Work States</a>
        </div>
      }

      @if (canAccessAdmin) {
        <div class="mobile-nav-section">
          <div class="mobile-nav-section-title">Administration</div>
          <a routerLink="/admin/users" class="mobile-nav-link" (click)="closeMobileNav()">User Management</a>
        </div>
      }
    </div>
  </nav>
}

<!-- User Switcher Panel (Testing) -->
@if (showUserSwitcher) {
  <div class="switcher-overlay" (click)="showUserSwitcher = false" (keydown.escape)="showUserSwitcher = false" tabindex="-1" role="presentation"></div>
  <div class="user-switcher-panel">
    <div class="switcher-header">
      <h3>Switch User Persona</h3>
      <button class="switcher-close" (click)="showUserSwitcher = false" aria-label="Close user switcher">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="switcher-body">
      @if (!switcherLoaded) {
        <div class="switcher-loading">Loading users...</div>
      } @else {
        @for (role of roles; track role) {
          @if (getUsersByRole(role).length > 0) {
            <div class="switcher-group">
              <div class="switcher-group-label">{{ role }}</div>
              @for (u of getUsersByRole(role); track u.id) {
                <button
                  class="switcher-user"
                  [class.current]="(user$ | async)?.id === u.id"
                  (click)="switchToUser(u)"
                >
                  <div class="switcher-user-info">
                    <span class="switcher-user-name">{{ u.displayName }}</span>
                    <span class="switcher-user-detail">
                      {{ u.username }}
                      @if (u.teamId) {
                        Â· {{ getTeamName(u.teamId) }}
                      }
                    </span>
                    @if (u.skills && u.skills.length > 0) {
                      <span class="switcher-user-skills">{{ u.skills.join(', ') }}</span>
                    }
                  </div>
                  @if ((user$ | async)?.id === u.id) {
                    <span class="current-badge">Current</span>
                  }
                </button>
              }
            </div>
          }
        }
      }
    </div>
    <div class="switcher-footer">
      <button class="switcher-logout" (click)="logout()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Back to Persona Selector
      </button>
    </div>
  </div>
}
