@if (showBar$ | async) {
  <div class="action-bar">
    @if (agentState$ | async; as state) {
      <!-- Work Type Badge (only during active task) -->
      @if (state === 'ACTIVE' || state === 'WRAP_UP') {
        @if (workType$ | async; as workType) {
          <div class="work-type-badge" [attr.data-type]="workType">
            {{ workType }}
          </div>
        }
      }

      <!-- Active State: Dynamic action buttons -->
      @if (state === 'ACTIVE') {
        <div class="task-actions">
          @for (action of actions$ | async; track action.id) {
            <button
              [class]="getButtonClass(action)"
              (click)="onActionClick(action)"
            >
              {{ action.label }}
            </button>
          }
        </div>
      }

      <!-- Wrap-up State: Disposition buttons (from backend) -->
      @if (state === 'WRAP_UP') {
        <div class="disposition-actions">
          <span class="disposition-prompt">Select disposition:</span>
          <div class="disposition-buttons">
            @for (disposition of dispositions$ | async; track disposition.id) {
              <button
                [class]="getDispositionButtonClass(disposition)"
                [title]="disposition.description || disposition.name"
                (click)="onDispositionSelect(disposition)"
              >
                @if (disposition.requiresNote) {
                  <span class="note-indicator" title="Note required">*</span>
                }
                {{ disposition.name }}
              </button>
            } @empty {
              <!-- Fallback to legacy actions if no dispositions configured -->
              @for (action of actions$ | async; track action.id) {
                @if (action.type === 'COMPLETE') {
                  <button
                    [class]="getButtonClass(action)"
                    (click)="onActionClick(action)"
                  >
                    {{ action.label }}
                  </button>
                }
              }
            }
          </div>
        </div>
      }

      <!-- IDLE State: Post-disposition options (Get Next Task or Work State) -->
      @if (state === 'IDLE' && showPostDisposition) {
        <div class="post-disposition-actions">
          <button
            class="action-btn get-next"
            (click)="onGetNextTask()"
            [disabled]="requestingNext"
          >
            @if (requestingNext) {
              <span class="btn-spinner"></span>
              Requesting...
            } @else {
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
              Get Next Task
            }
          </button>

          @if (selectableWorkStates.length > 0) {
            <span class="divider-text">or</span>
            <div class="work-state-options">
              @for (ws of selectableWorkStates; track ws.id) {
                <button
                  class="action-btn work-state-btn"
                  [title]="ws.name"
                  (click)="onSelectWorkState(ws)"
                >
                  {{ ws.name }}
                </button>
              }
            </div>
          }
        </div>
      }
    }
  </div>
}

<!-- Note Modal -->
@if (showNoteModal && selectedDisposition) {
  <div class="modal-overlay" (click)="closeNoteModal()">
    <div class="note-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add Note</h3>
        <button class="close-btn" (click)="closeNoteModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="disposition-info">
          Disposition: <strong>{{ selectedDisposition.name }}</strong>
        </p>
        <label for="note-input">Note <span class="required">*</span></label>
        <textarea
          id="note-input"
          [(ngModel)]="noteText"
          placeholder="Enter a note for this disposition..."
          rows="4"
          class="note-input"
        ></textarea>
      </div>
      <div class="modal-footer">
        <button class="action-btn" (click)="closeNoteModal()">Cancel</button>
        <button
          class="action-btn primary"
          [disabled]="!noteText.trim()"
          (click)="onSubmitNote()"
        >
          Submit
        </button>
      </div>
    </div>
  </div>
}
