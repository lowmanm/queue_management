@if (showBar$ | async) {
  <div class="action-bar">
    @if (agentState$ | async; as state) {
      <!-- Work Type Badge -->
      @if (workType$ | async; as workType) {
        <div class="work-type-badge" [attr.data-type]="workType">
          {{ workType }}
        </div>
      }

      <!-- Reserved State: Accept/Reject buttons with countdown -->
      @if (state === 'RESERVED') {
        <div class="reservation-actions">
          <span class="reservation-prompt">
            New task assigned
            @if (countdown$ | async; as countdown) {
              <span class="countdown" [class.urgent]="countdown <= 10">
                ({{ countdown }}s)
              </span>
            }
          </span>
          <div class="reservation-buttons">
            <button class="action-btn accept" (click)="onAccept()">
              Accept
            </button>
            <button class="action-btn reject" (click)="onReject()">
              Reject
            </button>
          </div>
        </div>
      }

      <!-- Active State: Dynamic action buttons -->
      @if (state === 'ACTIVE') {
        <div class="task-actions">
          @for (action of actions$ | async; track action.id) {
            <button
              [class]="getButtonClass(action)"
              (click)="onActionClick(action)"
            >
              {{ action.label }}
            </button>
          }
        </div>
      }

      <!-- Wrap-up State: Disposition buttons (from backend) -->
      @if (state === 'WRAP_UP') {
        <div class="disposition-actions">
          <span class="disposition-prompt">Select disposition:</span>
          <div class="disposition-buttons">
            @for (disposition of dispositions$ | async; track disposition.id) {
              <button
                [class]="getDispositionButtonClass(disposition)"
                [title]="disposition.description || disposition.name"
                (click)="onDispositionSelect(disposition)"
              >
                @if (disposition.requiresNote) {
                  <span class="note-indicator" title="Note required">*</span>
                }
                {{ disposition.name }}
              </button>
            } @empty {
              <!-- Fallback to legacy actions if no dispositions configured -->
              @for (action of actions$ | async; track action.id) {
                @if (action.type === 'COMPLETE') {
                  <button
                    [class]="getButtonClass(action)"
                    (click)="onActionClick(action)"
                  >
                    {{ action.label }}
                  </button>
                }
              }
            }
          </div>
        </div>
      }
    }
  </div>
}

<!-- Note Modal -->
@if (showNoteModal && selectedDisposition) {
  <div class="modal-overlay" (click)="closeNoteModal()">
    <div class="note-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Add Note</h3>
        <button class="close-btn" (click)="closeNoteModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="disposition-info">
          Disposition: <strong>{{ selectedDisposition.name }}</strong>
        </p>
        <label for="note-input">Note <span class="required">*</span></label>
        <textarea
          id="note-input"
          [(ngModel)]="noteText"
          placeholder="Enter a note for this disposition..."
          rows="4"
          class="note-input"
        ></textarea>
      </div>
      <div class="modal-footer">
        <button class="action-btn" (click)="closeNoteModal()">Cancel</button>
        <button
          class="action-btn primary"
          [disabled]="!noteText.trim()"
          (click)="onSubmitNote()"
        >
          Submit
        </button>
      </div>
    </div>
  </div>
}
