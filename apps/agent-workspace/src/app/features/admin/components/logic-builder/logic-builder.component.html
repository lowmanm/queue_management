<div class="logic-builder">
  <!-- Header -->
  <header class="builder-header">
    <h1>Logic Builder</h1>
    <p class="subtitle">Configure queue routing and priority rules</p>
  </header>

  <div class="builder-content">
    <!-- Rule Sets Panel -->
    <aside class="rule-sets-panel">
      <div class="panel-header">
        <h2>Rule Sets</h2>
        <button class="btn-icon" (click)="createNewRuleSet()" title="Create New Rule Set">
          +
        </button>
      </div>

      @if (isLoading) {
        <div class="loading">Loading...</div>
      } @else {
        <ul class="rule-sets-list">
          @for (ruleSet of ruleSets; track trackByRuleSet($index, ruleSet)) {
            <li
              class="rule-set-item"
              [class.selected]="selectedRuleSet?.id === ruleSet.id"
              [class.disabled]="!ruleSet.enabled"
              (click)="selectRuleSet(ruleSet)"
            >
              <span class="status-dot" [class.active]="ruleSet.enabled"></span>
              <span class="name">{{ ruleSet.name }}</span>
              <span class="rule-count">{{ ruleSet.rules.length }} rules</span>
            </li>
          } @empty {
            <li class="empty-state">No rule sets defined</li>
          }
        </ul>
      }
    </aside>

    <!-- Main Editor -->
    <main class="editor-panel">
      @if (!selectedRuleSet) {
        <div class="empty-state-large">
          <h3>Select a Rule Set</h3>
          <p>Choose a rule set from the left panel or create a new one</p>
        </div>
      } @else {
        <!-- Rule Set Header -->
        <div class="rule-set-header">
          <div class="rule-set-info">
            @if (editMode) {
              <input
                type="text"
                class="name-input"
                [(ngModel)]="selectedRuleSet.name"
                placeholder="Rule Set Name"
              />
              <textarea
                class="description-input"
                [(ngModel)]="selectedRuleSet.description"
                placeholder="Description (optional)"
                rows="2"
              ></textarea>
            } @else {
              <h2>{{ selectedRuleSet.name }}</h2>
              @if (selectedRuleSet.description) {
                <p class="description">{{ selectedRuleSet.description }}</p>
              }
            }
          </div>

          <div class="rule-set-actions">
            <label class="toggle-label">
              <input
                type="checkbox"
                [checked]="selectedRuleSet.enabled"
                (change)="toggleRuleSetEnabled()"
              />
              Enabled
            </label>

            @if (editMode) {
              <button class="btn-primary" (click)="saveRuleSet()" [disabled]="isSaving">
                {{ isSaving ? 'Saving...' : 'Save Rule Set' }}
              </button>
              <button class="btn-secondary" (click)="editMode = false">Cancel</button>
            } @else {
              <button class="btn-secondary" (click)="editMode = true">Edit</button>
              <button class="btn-danger" (click)="deleteRuleSet()">Delete</button>
            }
          </div>
        </div>

        <!-- Rules List -->
        <div class="rules-section">
          <div class="section-header">
            <h3>Rules</h3>
            <button class="btn-secondary" (click)="createNewRule()">+ Add Rule</button>
          </div>

          <div class="rules-list">
            @for (rule of selectedRuleSet.rules; track trackByRule($index, rule); let i = $index) {
              <div class="rule-card" [class.disabled]="!rule.enabled">
                <div class="rule-order">
                  <button
                    class="btn-icon-small"
                    (click)="moveRuleUp(i)"
                    [disabled]="i === 0"
                    title="Move Up"
                  >
                    ▲
                  </button>
                  <span class="order-num">{{ rule.order }}</span>
                  <button
                    class="btn-icon-small"
                    (click)="moveRuleDown(i)"
                    [disabled]="i === selectedRuleSet.rules.length - 1"
                    title="Move Down"
                  >
                    ▼
                  </button>
                </div>

                <div class="rule-content" (click)="selectRule(rule)">
                  <div class="rule-header">
                    <span class="rule-name">{{ rule.name }}</span>
                    <span class="rule-status" [class.enabled]="rule.enabled">
                      {{ rule.enabled ? 'Active' : 'Disabled' }}
                    </span>
                  </div>

                  <div class="rule-summary">
                    <span class="conditions-count">
                      {{ rule.conditionGroup.conditions.length }} condition(s)
                    </span>
                    <span class="operator">{{ rule.conditionGroup.operator }}</span>
                    <span class="actions-count">
                      {{ rule.actions.length }} action(s)
                    </span>
                  </div>

                  @if (rule.description) {
                    <p class="rule-description">{{ rule.description }}</p>
                  }
                </div>

                <div class="rule-actions">
                  <button class="btn-icon-small" (click)="toggleRuleEnabled(rule)" title="Toggle Enabled">
                    {{ rule.enabled ? '◉' : '○' }}
                  </button>
                  <button class="btn-icon-small danger" (click)="deleteRule(rule)" title="Delete Rule">
                    ×
                  </button>
                </div>
              </div>
            } @empty {
              <div class="empty-rules">
                <p>No rules defined. Click "Add Rule" to create one.</p>
              </div>
            }
          </div>
        </div>
      }
    </main>

    <!-- Rule Editor Sidebar -->
    @if (showRuleEditor && selectedRule) {
      <aside class="rule-editor-panel">
        <div class="panel-header">
          <h2>Edit Rule</h2>
          <button class="btn-icon" (click)="cancelRuleEdit()">×</button>
        </div>

        <div class="rule-editor">
          <!-- Basic Info -->
          <div class="form-group">
            <label>Rule Name</label>
            <input type="text" [(ngModel)]="selectedRule.name" placeholder="Enter rule name" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea
              [(ngModel)]="selectedRule.description"
              placeholder="Describe what this rule does"
              rows="2"
            ></textarea>
          </div>

          <div class="form-group inline">
            <label>
              <input type="checkbox" [(ngModel)]="selectedRule.enabled" />
              Rule Enabled
            </label>
          </div>

          <!-- Conditions -->
          <div class="section">
            <div class="section-header">
              <h4>Conditions</h4>
              <div class="operator-toggle">
                <button
                  [class.active]="selectedRule.conditionGroup.operator === 'AND'"
                  (click)="setConditionOperator('AND')"
                >
                  AND
                </button>
                <button
                  [class.active]="selectedRule.conditionGroup.operator === 'OR'"
                  (click)="setConditionOperator('OR')"
                >
                  OR
                </button>
              </div>
            </div>

            <div class="conditions-list">
              @for (condition of selectedRule.conditionGroup.conditions; track trackByCondition($index, condition); let i = $index) {
                <div class="condition-row">
                  <select [(ngModel)]="condition.field">
                    @for (field of fields; track field.field) {
                      <option [value]="field.field">{{ field.label }}</option>
                    }
                  </select>

                  <select [(ngModel)]="condition.operator">
                    @for (op of getOperatorsForField(condition.field); track op.operator) {
                      <option [value]="op.operator">{{ op.label }}</option>
                    }
                  </select>

                  @if (condition.operator !== 'is_empty' && condition.operator !== 'is_not_empty') {
                    @if (getFieldConfig(condition.field)?.valueType === 'select') {
                      <select [(ngModel)]="condition.value">
                        @for (opt of getFieldConfig(condition.field)?.options || []; track opt.value) {
                          <option [value]="opt.value">{{ opt.label }}</option>
                        }
                      </select>
                    } @else if (getFieldConfig(condition.field)?.valueType === 'number') {
                      <input type="number" [(ngModel)]="condition.value" />
                    } @else {
                      <input type="text" [(ngModel)]="condition.value" placeholder="Value" />
                    }
                  }

                  <button class="btn-icon-small danger" (click)="removeCondition(i)">×</button>
                </div>

                @if (i < selectedRule.conditionGroup.conditions.length - 1) {
                  <div class="condition-connector">{{ selectedRule.conditionGroup.operator }}</div>
                }
              }
            </div>

            <button class="btn-add" (click)="addCondition()">+ Add Condition</button>
          </div>

          <!-- Actions -->
          <div class="section">
            <div class="section-header">
              <h4>Actions</h4>
            </div>

            <div class="actions-list">
              @for (action of selectedRule.actions; track trackByAction($index, action); let i = $index) {
                <div class="action-row">
                  <select [(ngModel)]="action.type">
                    @for (actionConfig of actions; track actionConfig.type) {
                      <option [value]="actionConfig.type">{{ actionConfig.label }}</option>
                    }
                  </select>

                  @if (getActionConfig(action.type)?.requiresField) {
                    <input type="text" [(ngModel)]="action.field" placeholder="Field name" />
                  }

                  @if (getActionConfig(action.type)?.valueType === 'select') {
                    <select [(ngModel)]="action.value">
                      @for (opt of getActionConfig(action.type)?.options || []; track opt.value) {
                        <option [value]="opt.value">{{ opt.label }}</option>
                      }
                    </select>
                  } @else if (getActionConfig(action.type)?.valueType === 'number') {
                    <input type="number" [(ngModel)]="action.value" />
                  } @else if (getActionConfig(action.type)?.valueType !== 'boolean') {
                    <input type="text" [(ngModel)]="action.value" placeholder="Value" />
                  }

                  <button class="btn-icon-small danger" (click)="removeAction(i)">×</button>
                </div>
              }
            </div>

            <button class="btn-add" (click)="addAction()">+ Add Action</button>
          </div>

          <!-- Save/Cancel -->
          <div class="editor-footer">
            <button class="btn-primary" (click)="saveRule()">Save Rule</button>
            <button class="btn-secondary" (click)="cancelRuleEdit()">Cancel</button>
          </div>
        </div>
      </aside>
    }
  </div>
</div>
