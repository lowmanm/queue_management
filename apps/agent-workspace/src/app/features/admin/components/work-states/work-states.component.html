<div class="work-states-container">
  <header class="page-header">
    <div class="header-content">
      <h1>Work States</h1>
      <p class="subtitle">Configure unavailable states for agents</p>
    </div>
    <button class="create-btn" (click)="openCreate()" [disabled]="loading()">
      <span class="icon">add</span>
      Create State
    </button>
  </header>

  <!-- Messages -->
  @if (error()) {
    <div class="message error">
      {{ error() }}
      <button class="dismiss" (click)="error.set(null)">dismiss</button>
    </div>
  }
  @if (success()) {
    <div class="message success">
      {{ success() }}
    </div>
  }

  <!-- System States (Read-only) -->
  <section class="states-section">
    <h2 class="section-title">
      <span class="icon">lock</span>
      System States
      <span class="badge">Fixed</span>
    </h2>
    <p class="section-desc">Core workflow states that cannot be modified</p>

    <div class="states-grid">
      @for (state of systemStates(); track state.id) {
        <div class="state-card system" [style.--state-color]="state.color">
          <div class="state-header">
            <span class="state-icon" [style.background]="state.color">
              {{ getIconClass(state.icon) }}
            </span>
            <div class="state-info">
              <span class="state-name">{{ state.name }}</span>
              <span class="state-id">{{ state.id }}</span>
            </div>
          </div>
          <div class="state-details">
            <div class="detail">
              <span class="label">Category:</span>
              <span class="value category-{{ state.category }}">{{ state.category }}</span>
            </div>
            @if (state.isProductive) {
              <span class="tag productive">Productive</span>
            }
            @if (state.isBillable) {
              <span class="tag billable">Billable</span>
            }
          </div>
        </div>
      }
    </div>
  </section>

  <!-- Custom States -->
  <section class="states-section">
    <h2 class="section-title">
      <span class="icon">tune</span>
      Custom Unavailable States
      <span class="badge count">{{ customStates().length }}</span>
    </h2>
    <p class="section-desc">Configurable states for breaks, meetings, and other activities</p>

    @if (loading() && customStates().length === 0) {
      <div class="loading">Loading...</div>
    } @else if (customStates().length === 0) {
      <div class="empty-state">
        <span class="icon">inbox</span>
        <p>No custom states yet</p>
        <button class="create-btn-small" (click)="openCreate()">Create your first state</button>
      </div>
    } @else {
      <div class="states-grid">
        @for (state of customStates(); track state.id) {
          <div class="state-card" [class.inactive]="!state.active" [style.--state-color]="state.color">
            <div class="state-header">
              <span class="state-icon" [style.background]="state.color">
                {{ getIconClass(state.icon) }}
              </span>
              <div class="state-info">
                <span class="state-name">{{ state.name }}</span>
                <span class="state-id">{{ state.id }}</span>
              </div>
              <div class="state-actions">
                <button class="action-btn" (click)="openEdit(state)" title="Edit">
                  <span class="icon">edit</span>
                </button>
                <button class="action-btn" (click)="toggleState(state)" [title]="state.active ? 'Disable' : 'Enable'">
                  <span class="icon">{{ state.active ? 'visibility_off' : 'visibility' }}</span>
                </button>
                <button class="action-btn delete" (click)="deleteState(state)" title="Delete">
                  <span class="icon">delete</span>
                </button>
              </div>
            </div>
            <div class="state-details">
              <div class="detail-row">
                @if (state.agentSelectable) {
                  <span class="tag selectable">Agent Selectable</span>
                }
                @if (state.isBillable) {
                  <span class="tag billable">Billable</span>
                }
                @if (state.requiresApproval) {
                  <span class="tag approval">Requires Approval</span>
                }
              </div>
              @if (state.maxDurationMinutes > 0) {
                <div class="detail">
                  <span class="label">Max Duration:</span>
                  <span class="value">{{ state.maxDurationMinutes }} min</span>
                </div>
              }
              @if (!state.active) {
                <span class="inactive-badge">Disabled</span>
              }
            </div>
          </div>
        }
      </div>
    }
  </section>
</div>

<!-- Create/Edit Modal -->
@if (isEditing()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ modalTitle() }}</h2>
        <button class="close-btn" (click)="closeModal()">
          <span class="icon">close</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Name -->
        <div class="form-group">
          <label>Name</label>
          <input
            type="text"
            [ngModel]="formName()"
            (ngModelChange)="formName.set($event)"
            placeholder="e.g., Doctor Appointment"
          />
        </div>

        <!-- Color -->
        <div class="form-group">
          <label>Color</label>
          <div class="color-picker">
            <div class="color-preview" [style.background]="formColor()"></div>
            <div class="color-presets">
              @for (color of colorPresets; track color) {
                <button
                  class="color-swatch"
                  [style.background]="color"
                  [class.selected]="formColor() === color"
                  (click)="selectColor(color)"
                ></button>
              }
            </div>
            <input
              type="color"
              [ngModel]="formColor()"
              (ngModelChange)="formColor.set($event)"
            />
          </div>
        </div>

        <!-- Icon -->
        <div class="form-group">
          <label>Icon</label>
          <div class="icon-picker">
            @for (icon of availableIcons; track icon) {
              <button
                class="icon-option"
                [class.selected]="formIcon() === icon"
                (click)="selectIcon(icon)"
                [title]="icon"
              >
                <span class="material-icon">{{ getIconClass(icon) }}</span>
              </button>
            }
          </div>
        </div>

        <!-- Options -->
        <div class="form-group options">
          <label>Options</label>
          <div class="checkbox-group">
            <label class="checkbox">
              <input
                type="checkbox"
                [ngModel]="formAgentSelectable()"
                (ngModelChange)="formAgentSelectable.set($event)"
              />
              <span>Agent can select this state</span>
            </label>
            <label class="checkbox">
              <input
                type="checkbox"
                [ngModel]="formIsBillable()"
                (ngModelChange)="formIsBillable.set($event)"
              />
              <span>Billable time</span>
            </label>
            <label class="checkbox">
              <input
                type="checkbox"
                [ngModel]="formRequiresApproval()"
                (ngModelChange)="formRequiresApproval.set($event)"
              />
              <span>Requires manager approval</span>
            </label>
          </div>
        </div>

        <!-- Duration -->
        <div class="form-group">
          <label>Maximum Duration (minutes, 0 = unlimited)</label>
          <input
            type="number"
            [ngModel]="formMaxDuration()"
            (ngModelChange)="formMaxDuration.set($event)"
            min="0"
          />
        </div>

        @if (formMaxDuration() > 0) {
          <div class="form-group">
            <label class="checkbox">
              <input
                type="checkbox"
                [ngModel]="formWarnBeforeMax()"
                (ngModelChange)="formWarnBeforeMax.set($event)"
              />
              <span>Warn before max duration</span>
            </label>
            @if (formWarnBeforeMax()) {
              <div class="sub-input">
                <label>Minutes before max to warn</label>
                <input
                  type="number"
                  [ngModel]="formWarnMinutes()"
                  (ngModelChange)="formWarnMinutes.set($event)"
                  min="1"
                  [max]="formMaxDuration()"
                />
              </div>
            }
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn secondary" (click)="closeModal()">Cancel</button>
        <button class="btn primary" (click)="save()" [disabled]="loading()">
          {{ editMode() === 'create' ? 'Create' : 'Save Changes' }}
        </button>
      </div>
    </div>
  </div>
}
