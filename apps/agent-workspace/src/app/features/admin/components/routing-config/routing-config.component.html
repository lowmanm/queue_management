<div class="routing-config">
  <header class="page-header">
    <div class="header-content">
      <h1>Routing Configuration</h1>
      <p class="subtitle">Manage skill-based routing and workload balancing</p>
    </div>
    <button class="btn btn-icon" (click)="refreshData()" [disabled]="loading$ | async">
      <span class="icon">&#x21bb;</span>
    </button>
  </header>

  <!-- Summary Cards -->
  @if (summary$ | async; as summary) {
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-value">{{ summary.activeStrategies }}/{{ summary.totalStrategies }}</div>
        <div class="card-label">Active Strategies</div>
      </div>
      <div class="summary-card">
        <div class="card-value">{{ summary.activeSkills }}/{{ summary.totalSkills }}</div>
        <div class="card-label">Active Skills</div>
      </div>
      <div class="summary-card">
        <div class="card-value">{{ getAlgorithmName(summary.defaultAlgorithm) }}</div>
        <div class="card-label">Default Algorithm</div>
      </div>
      <div class="summary-card">
        <div class="card-value" [class.active]="summary.workloadBalancingEnabled">
          {{ summary.workloadBalancingEnabled ? 'Enabled' : 'Disabled' }}
        </div>
        <div class="card-label">Workload Balancing</div>
      </div>
    </div>
  }

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab === 'skills'"
      (click)="setActiveTab('skills')"
    >
      Skills
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'strategies'"
      (click)="setActiveTab('strategies')"
    >
      Routing Strategies
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'workload'"
      (click)="setActiveTab('workload')"
    >
      Workload Monitor
    </button>
  </div>

  <!-- Skills Tab -->
  @if (activeTab === 'skills') {
    <div class="tab-content">
      <div class="toolbar">
        <h2>Skills Management</h2>
        <button class="btn btn-primary" (click)="openAddSkillModal()">+ Add Skill</button>
      </div>

      @if (skills$ | async; as skills) {
        @for (category of categories; track category.id) {
          @if (getSkillsByCategory(skills, category.id).length > 0) {
            <div class="skill-category">
              <h3 class="category-title">{{ category.name }}</h3>
              <div class="skills-grid">
                @for (skill of getSkillsByCategory(skills, category.id); track skill.id) {
                  <div class="skill-card" [class.inactive]="!skill.active">
                    <div class="skill-header">
                      <span class="skill-name">{{ skill.name }}</span>
                      <span class="skill-status" [class.active]="skill.active">
                        {{ skill.active ? 'Active' : 'Inactive' }}
                      </span>
                    </div>
                    @if (skill.description) {
                      <p class="skill-description">{{ skill.description }}</p>
                    }
                    <div class="skill-actions">
                      <button class="btn btn-sm" (click)="openEditSkillModal(skill)">Edit</button>
                      <button class="btn btn-sm" (click)="toggleSkillActive(skill)">
                        {{ skill.active ? 'Disable' : 'Enable' }}
                      </button>
                      <button class="btn btn-sm btn-danger" (click)="deleteSkill(skill)">Delete</button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        }

        @if (skills.length === 0) {
          <div class="empty-state">
            <p>No skills configured yet.</p>
            <button class="btn btn-primary" (click)="openAddSkillModal()">Add First Skill</button>
          </div>
        }
      }
    </div>
  }

  <!-- Strategies Tab -->
  @if (activeTab === 'strategies') {
    <div class="tab-content">
      <div class="toolbar">
        <h2>Routing Strategies</h2>
        <button class="btn btn-primary" (click)="openAddStrategyModal()">+ Add Strategy</button>
      </div>

      @if (strategies$ | async; as strategies) {
        <div class="strategies-list">
          @for (strategy of strategies; track strategy.id) {
            <div class="strategy-card" [class.inactive]="!strategy.active">
              <div class="strategy-header">
                <div class="strategy-info">
                  <span class="strategy-name">{{ strategy.name }}</span>
                  <span class="strategy-priority">Priority: {{ strategy.priority }}</span>
                </div>
                <div class="strategy-status">
                  <span class="algorithm-badge">{{ getAlgorithmName(strategy.algorithm) }}</span>
                  <span class="status-badge" [class.active]="strategy.active">
                    {{ strategy.active ? 'Active' : 'Inactive' }}
                  </span>
                </div>
              </div>

              @if (strategy.description) {
                <p class="strategy-description">{{ strategy.description }}</p>
              }

              <div class="strategy-details">
                <div class="detail-group">
                  <span class="detail-label">Skill Matching:</span>
                  <span class="detail-value">
                    {{ strategy.skillMatching.mode }}
                    (min proficiency: {{ strategy.skillMatching.minimumProficiency }})
                  </span>
                </div>
                <div class="detail-group">
                  <span class="detail-label">Workload Balancing:</span>
                  <span class="detail-value">
                    {{ strategy.workloadBalancing.enabled ? 'Enabled' : 'Disabled' }}
                    @if (strategy.workloadBalancing.enabled) {
                      (max {{ strategy.workloadBalancing.maxConcurrentTasks }} concurrent)
                    }
                  </span>
                </div>
                <div class="detail-group">
                  <span class="detail-label">Fallback:</span>
                  <span class="detail-value">{{ strategy.fallbackBehavior.action.replace('_', ' ') }}</span>
                </div>
              </div>

              <div class="strategy-actions">
                <button class="btn btn-sm" (click)="openEditStrategyModal(strategy)">Edit</button>
                <button class="btn btn-sm" (click)="toggleStrategyActive(strategy)">
                  {{ strategy.active ? 'Disable' : 'Enable' }}
                </button>
                @if (strategy.id !== 'default') {
                  <button class="btn btn-sm btn-danger" (click)="deleteStrategy(strategy)">Delete</button>
                }
              </div>
            </div>
          }
        </div>

        @if (strategies.length === 0) {
          <div class="empty-state">
            <p>No routing strategies configured.</p>
            <button class="btn btn-primary" (click)="openAddStrategyModal()">Add Strategy</button>
          </div>
        }
      }
    </div>
  }

  <!-- Workload Monitor Tab -->
  @if (activeTab === 'workload') {
    <div class="tab-content">
      <div class="toolbar">
        <h2>Agent Workload</h2>
        <button class="btn btn-sm" (click)="refreshData()">Refresh</button>
      </div>

      @if (capacities$ | async; as capacities) {
        <div class="capacity-grid">
          @for (capacity of capacities; track capacity.agentId) {
            <div class="capacity-card" [class]="getCapacityClass(capacity)">
              <div class="capacity-header">
                <span class="agent-id">{{ capacity.agentId }}</span>
                <span class="agent-state" [class]="getStateClass(capacity.state)">
                  {{ capacity.state }}
                </span>
              </div>

              <div class="capacity-metrics">
                <div class="metric">
                  <span class="metric-label">Tasks</span>
                  <span class="metric-value">{{ capacity.activeTasks }}/{{ capacity.maxTasks }}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Utilization</span>
                  <span class="metric-value">{{ capacity.utilization | number:'1.0-0' }}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Idle Time</span>
                  <span class="metric-value">{{ formatIdleTime(capacity.idleTime) }}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Completed Today</span>
                  <span class="metric-value">{{ capacity.tasksCompletedToday }}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Avg Handle</span>
                  <span class="metric-value">{{ capacity.avgHandleTimeToday }}s</span>
                </div>
              </div>

              <div class="capacity-status">
                @if (capacity.available) {
                  <span class="available-badge">Available</span>
                } @else if (capacity.atCapacity) {
                  <span class="at-capacity-badge">At Capacity</span>
                } @else {
                  <span class="unavailable-badge">Unavailable</span>
                }
              </div>
            </div>
          }
        </div>

        @if (capacities.length === 0) {
          <div class="empty-state">
            <p>No agents currently connected.</p>
          </div>
        }
      }
    </div>
  }
</div>

<!-- Skill Modal -->
@if (showSkillModal) {
  <div class="modal-backdrop" (click)="closeSkillModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditing ? 'Edit Skill' : 'Add Skill' }}</h3>
        <button class="btn-close" (click)="closeSkillModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Name</label>
          <input type="text" [(ngModel)]="selectedSkill.name" placeholder="Skill name" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="selectedSkill.description" placeholder="Optional description"></textarea>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select [(ngModel)]="selectedSkill.category">
            @for (cat of categories; track cat.id) {
              <option [value]="cat.id">{{ cat.name }}</option>
            }
          </select>
        </div>
        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="selectedSkill.active" />
            Active
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closeSkillModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveSkill()" [disabled]="!selectedSkill.name">
          {{ isEditing ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Strategy Modal -->
@if (showStrategyModal) {
  <div class="modal-backdrop" (click)="closeStrategyModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditing ? 'Edit Strategy' : 'Add Strategy' }}</h3>
        <button class="btn-close" (click)="closeStrategyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" [(ngModel)]="selectedStrategy.name" placeholder="Strategy name" />
          </div>
          <div class="form-group">
            <label>Priority (lower = higher)</label>
            <input type="number" [(ngModel)]="selectedStrategy.priority" min="1" max="100" />
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="selectedStrategy.description" placeholder="Optional description"></textarea>
        </div>

        <div class="form-group">
          <label>Routing Algorithm</label>
          <select [(ngModel)]="selectedStrategy.algorithm">
            @for (algo of algorithms; track algo.id) {
              <option [value]="algo.id">{{ algo.name }} - {{ algo.description }}</option>
            }
          </select>
        </div>

        <fieldset class="form-section">
          <legend>Skill Matching</legend>
          <div class="form-row">
            <div class="form-group">
              <label>Mode</label>
              <select [(ngModel)]="selectedStrategy.skillMatching!.mode">
                <option value="strict">Strict (all skills required)</option>
                <option value="flexible">Flexible (majority required)</option>
                <option value="any">Any (at least one)</option>
                <option value="best-match">Best Match (score & rank)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Minimum Proficiency</label>
              <select [(ngModel)]="selectedStrategy.skillMatching!.minimumProficiency">
                <option [value]="1">1 - Novice</option>
                <option [value]="2">2 - Basic</option>
                <option [value]="3">3 - Intermediate</option>
                <option [value]="4">4 - Advanced</option>
                <option [value]="5">5 - Expert</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Proficiency Weight (0-100)</label>
              <input
                type="number"
                [(ngModel)]="selectedStrategy.skillMatching!.proficiencyWeight"
                min="0"
                max="100"
              />
            </div>
            <div class="form-group checkbox-group">
              <label>
                <input
                  type="checkbox"
                  [(ngModel)]="selectedStrategy.skillMatching!.requireAllSkills"
                />
                Require All Skills
              </label>
            </div>
          </div>
        </fieldset>

        <fieldset class="form-section">
          <legend>Workload Balancing</legend>
          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="selectedStrategy.workloadBalancing!.enabled"
              />
              Enable Workload Balancing
            </label>
          </div>
          @if (selectedStrategy.workloadBalancing?.enabled) {
            <div class="form-row">
              <div class="form-group">
                <label>Max Concurrent Tasks</label>
                <input
                  type="number"
                  [(ngModel)]="selectedStrategy.workloadBalancing!.maxConcurrentTasks"
                  min="1"
                  max="10"
                />
              </div>
              <div class="form-group">
                <label>Max Tasks Per Agent</label>
                <input
                  type="number"
                  [(ngModel)]="selectedStrategy.workloadBalancing!.maxTasksPerAgent"
                  min="1"
                  max="50"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Task Count Weight</label>
                <input
                  type="number"
                  [(ngModel)]="selectedStrategy.workloadBalancing!.taskCountWeight"
                  min="0"
                  max="100"
                />
              </div>
              <div class="form-group">
                <label>Handle Time Weight</label>
                <input
                  type="number"
                  [(ngModel)]="selectedStrategy.workloadBalancing!.handleTimeWeight"
                  min="0"
                  max="100"
                />
              </div>
              <div class="form-group">
                <label>Idle Time Weight</label>
                <input
                  type="number"
                  [(ngModel)]="selectedStrategy.workloadBalancing!.idleTimeWeight"
                  min="0"
                  max="100"
                />
              </div>
            </div>
          }
        </fieldset>

        <fieldset class="form-section">
          <legend>Fallback Behavior</legend>
          <div class="form-row">
            <div class="form-group">
              <label>Action</label>
              <select [(ngModel)]="selectedStrategy.fallbackBehavior!.action">
                <option value="wait">Wait for available agent</option>
                <option value="any_available">Assign to any available</option>
                <option value="route_to_queue">Route to fallback queue</option>
                <option value="escalate">Escalate to supervisor</option>
              </select>
            </div>
            <div class="form-group">
              <label>Wait Time (seconds)</label>
              <input
                type="number"
                [(ngModel)]="selectedStrategy.fallbackBehavior!.waitTimeSeconds"
                min="0"
                max="300"
              />
            </div>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="selectedStrategy.fallbackBehavior!.relaxSkillRequirements"
              />
              Relax Skill Requirements on Fallback
            </label>
          </div>
        </fieldset>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="selectedStrategy.active" />
            Active
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closeStrategyModal()">Cancel</button>
        <button
          class="btn btn-primary"
          (click)="saveStrategy()"
          [disabled]="!selectedStrategy.name"
        >
          {{ isEditing ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
}
